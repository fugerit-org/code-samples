package test.org.fugerit.java.code.samples.convert;

import lombok.extern.slf4j.Slf4j;
import org.fugerit.java.code.samples.convert.ConvertFacade;
import org.fugerit.java.code.samples.convert.ConvertJWT;
import org.fugerit.java.code.samples.convert.DeflateJWT;
import org.fugerit.java.code.samples.convert.PassThroughConvertUtil;
import org.fugerit.java.code.samples.deflate.DeflateGzipUtil;
import org.fugerit.java.code.samples.deflate.DeflateUtil;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.Arrays;

@Slf4j
class TestConvertFacade {

    /*
     * Example jwt from : https://jwt.io/#debugger-io
     */
    private static final String TEXT_SIZE_1 = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c";

    private static final String TEXT_SIZE_2 = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6Ikx1dGhpZW4iLCJpYXQiOjE1MTYyMzkwMjIsInVzZXIiOiJteXVzZXIxIiwiY2xpZW50SWQiOiJGdWdlcml0IE9SRyIsImFkZHJlc3MiOiJHb25kb2xpbiwgTWlkZGxlIEVhcnRoIiwicnVsZXIiOiJGaW53ZSwga2luZyBvZiBOb2xkb3IifQ.8DEsrNsFef-SU-5YDLCsigkmR93sez4kD9zRW_Q3IBs";

    private static final String TEXT_SIZE_3 = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6Ikx1dGhpZW4iLCJpYXQiOjE1MTYyMzkwMjIsInVzZXIiOiJteXVzZXIxIiwiY2xpZW50SWQiOiJGdWdlcml0IE9SRyIsImFkZHJlc3MiOiJHb25kb2xpbiwgTWlkZGxlIEVhcnRoIiwicnVsZXIiOiJGaW53ZSwga2luZyBvZiBOb2xkb3IiLCJ0ZXh0IjoiTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdC4gRXRpYW0gc2VtIG5lcXVlLCB0ZW1wdXMgcXVpcyBoZW5kcmVyaXQgdmVsLCBmaW5pYnVzIGF0IGlwc3VtLiBNYXVyaXMgYXQgbG9yZW0gZnJpbmdpbGxhLCBibGFuZGl0IGxlY3R1cyB2ZWwsIHNlbXBlciBkb2xvci4gVml2YW11cyBldCB0b3J0b3IgaW4gYXJjdSBiaWJlbmR1bSB2ZXN0aWJ1bHVtLiBOdW5jIHNlZCBmZXJtZW50dW0gbWkuIEFlbmVhbiBjb21tb2RvIGNvbW1vZG8gcmhvbmN1cy4gRXRpYW0gcGhhcmV0cmEgc2NlbGVyaXNxdWUgZHVpIGV1IHZvbHV0cGF0LiBGdXNjZSBldSBtYXVyaXMgYSBuZXF1ZSB0aW5jaWR1bnQgZXVpc21vZCBhYyBhYyB0b3J0b3IuIE51bGxhIHZvbHV0cGF0IG9yY2kgZXUgbmlzbCB2ZWhpY3VsYSwgYXQgYmxhbmRpdCBkaWFtIGx1Y3R1cy4ifQ.iBRGI3FGvnjEMLmmbjEnGlXk9NFsHfnCgZk2ZymNIm0";

    private static final String TEXT_SIZE_4 = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6Ikx1dGhpZW4iLCJpYXQiOjE1MTYyMzkwMjIsInVzZXIiOiJteXVzZXIxIiwiY2xpZW50SWQiOiJGdWdlcml0IE9SRyIsImFkZHJlc3MiOiJHb25kb2xpbiwgTWlkZGxlIEVhcnRoIiwicnVsZXIiOiJGaW53ZSwga2luZyBvZiBOb2xkb3IiLCJ0ZXh0IjoiTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdC4gRXRpYW0gc2VtIG5lcXVlLCB0ZW1wdXMgcXVpcyBoZW5kcmVyaXQgdmVsLCBmaW5pYnVzIGF0IGlwc3VtLiBNYXVyaXMgYXQgbG9yZW0gZnJpbmdpbGxhLCBibGFuZGl0IGxlY3R1cyB2ZWwsIHNlbXBlciBkb2xvci4gVml2YW11cyBldCB0b3J0b3IgaW4gYXJjdSBiaWJlbmR1bSB2ZXN0aWJ1bHVtLiBOdW5jIHNlZCBmZXJtZW50dW0gbWkuIEFlbmVhbiBjb21tb2RvIGNvbW1vZG8gcmhvbmN1cy4gRXRpYW0gcGhhcmV0cmEgc2NlbGVyaXNxdWUgZHVpIGV1IHZvbHV0cGF0LiBGdXNjZSBldSBtYXVyaXMgYSBuZXF1ZSB0aW5jaWR1bnQgZXVpc21vZCBhYyBhYyB0b3J0b3IuIE51bGxhIHZvbHV0cGF0IG9yY2kgZXUgbmlzbCB2ZWhpY3VsYSwgYXQgYmxhbmRpdCBkaWFtIGx1Y3R1cy4iLCJleHQiOiJBZW5lYW4gcGVsbGVudGVzcXVlIGZldWdpYXQgcXVhbSwgbm9uIHNjZWxlcmlzcXVlIHNhcGllbiBydXRydW0gZWdldC4gRHVpcyB1bHRyaWNlcyBvcmNpIHNpdCBhbWV0IHNhcGllbiBzYWdpdHRpcywgZXQgYXVjdG9yIG5pc2kgc2NlbGVyaXNxdWUuIFN1c3BlbmRpc3NlIGxlY3R1cyBudWxsYSwgc2NlbGVyaXNxdWUgZXQgbGVjdHVzIHNpdCBhbWV0LCBhdWN0b3IgY29uc2VjdGV0dXIgc2VtLiBOdWxsYW0gaWFjdWxpcyBwaGFyZXRyYSBmZWxpcyBub24gZWdlc3Rhcy4gQ3VyYWJpdHVyIGNvbnNlY3RldHVyIGxlbyByaXN1cywgdmVsIG1vbGVzdGllIHVybmEgbGFvcmVldCBldC4gRG9uZWMgZXUgZWxpdCBkYXBpYnVzLCBwaGFyZXRyYSBsaWJlcm8gZnJpbmdpbGxhLCBmZXVnaWF0IGV4LiBEb25lYyBwZWxsZW50ZXNxdWUsIGxlbyBzZWQgY29uc2VjdGV0dXIgdmVoaWN1bGEsIGVsaXQgZW5pbSBmcmluZ2lsbGEganVzdG8sIGF0IHZvbHV0cGF0IG9kaW8gdmVsaXQgbm9uIGxvcmVtLiBOdWxsYSBmYWNpbGlzaS4gTnVsbGEgcGVsbGVudGVzcXVlLCBuZXF1ZSBhYyBtYXR0aXMgc29sbGljaXR1ZGluLCBuaXNpIHB1cnVzIG1vbGVzdGllIHR1cnBpcywgYWMgbWF0dGlzIG1hZ25hIGxpZ3VsYSBpbnRlcmR1bSBleC4gQWxpcXVhbSBmcmluZ2lsbGEgZmVybWVudHVtIGVuaW0uIFBlbGxlbnRlc3F1ZSBjb25kaW1lbnR1bSBsZW8gc2l0IGFtZXQgZWdlc3RhcyB1bHRyaWNpZXMuIFZpdmFtdXMgZmFjaWxpc2lzIGxvcmVtIGV1IHF1YW0gY29uZ3VlLCBhYyBjb25ndWUgaXBzdW0gZWxlbWVudHVtLiBWZXN0aWJ1bHVtIGNvbnNlcXVhdCBkdWkgYWMgdG9ydG9yIGJsYW5kaXQgbW9sZXN0aWUuIFByb2luIHRlbXBvciBwb3J0dGl0b3IgZW5pbSBzaXQgYW1ldCB0aW5jaWR1bnQuIER1aXMgY29uZ3VlIG5pc2kgc2VkIG1hc3NhIGZlcm1lbnR1bSBibGFuZGl0LiBOdWxsYSBpbnRlcmR1bSB0b3J0b3IgaWQgYmliZW5kdW0gbGFjaW5pYS4ifQ.FCUgQrR3SEtwNsfwPgxhfNeCnA_Bjt_66r9r3NxRKvA";

    private static final String TEXT_SIZE_5 = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6Ikx1dGhpZW4iLCJpYXQiOjE1MTYyMzkwMjIsInVzZXIiOiJteXVzZXIxIiwiY2xpZW50SWQiOiJGdWdlcml0IE9SRyIsImFkZHJlc3MiOiJHb25kb2xpbiwgTWlkZGxlIEVhcnRoIiwicnVsZXIiOiJGaW53ZSwga2luZyBvZiBOb2xkb3IiLCJ0ZXh0IjoiTG9yZW0gaXBzdW0gZG9sb3Igc2l0IGFtZXQsIGNvbnNlY3RldHVyIGFkaXBpc2NpbmcgZWxpdC4gRXRpYW0gc2VtIG5lcXVlLCB0ZW1wdXMgcXVpcyBoZW5kcmVyaXQgdmVsLCBmaW5pYnVzIGF0IGlwc3VtLiBNYXVyaXMgYXQgbG9yZW0gZnJpbmdpbGxhLCBibGFuZGl0IGxlY3R1cyB2ZWwsIHNlbXBlciBkb2xvci4gVml2YW11cyBldCB0b3J0b3IgaW4gYXJjdSBiaWJlbmR1bSB2ZXN0aWJ1bHVtLiBOdW5jIHNlZCBmZXJtZW50dW0gbWkuIEFlbmVhbiBjb21tb2RvIGNvbW1vZG8gcmhvbmN1cy4gRXRpYW0gcGhhcmV0cmEgc2NlbGVyaXNxdWUgZHVpIGV1IHZvbHV0cGF0LiBGdXNjZSBldSBtYXVyaXMgYSBuZXF1ZSB0aW5jaWR1bnQgZXVpc21vZCBhYyBhYyB0b3J0b3IuIE51bGxhIHZvbHV0cGF0IG9yY2kgZXUgbmlzbCB2ZWhpY3VsYSwgYXQgYmxhbmRpdCBkaWFtIGx1Y3R1cy4iLCJleHQiOiJBZW5lYW4gcGVsbGVudGVzcXVlIGZldWdpYXQgcXVhbSwgbm9uIHNjZWxlcmlzcXVlIHNhcGllbiBydXRydW0gZWdldC4gRHVpcyB1bHRyaWNlcyBvcmNpIHNpdCBhbWV0IHNhcGllbiBzYWdpdHRpcywgZXQgYXVjdG9yIG5pc2kgc2NlbGVyaXNxdWUuIFN1c3BlbmRpc3NlIGxlY3R1cyBudWxsYSwgc2NlbGVyaXNxdWUgZXQgbGVjdHVzIHNpdCBhbWV0LCBhdWN0b3IgY29uc2VjdGV0dXIgc2VtLiBOdWxsYW0gaWFjdWxpcyBwaGFyZXRyYSBmZWxpcyBub24gZWdlc3Rhcy4gQ3VyYWJpdHVyIGNvbnNlY3RldHVyIGxlbyByaXN1cywgdmVsIG1vbGVzdGllIHVybmEgbGFvcmVldCBldC4gRG9uZWMgZXUgZWxpdCBkYXBpYnVzLCBwaGFyZXRyYSBsaWJlcm8gZnJpbmdpbGxhLCBmZXVnaWF0IGV4LiBEb25lYyBwZWxsZW50ZXNxdWUsIGxlbyBzZWQgY29uc2VjdGV0dXIgdmVoaWN1bGEsIGVsaXQgZW5pbSBmcmluZ2lsbGEganVzdG8sIGF0IHZvbHV0cGF0IG9kaW8gdmVsaXQgbm9uIGxvcmVtLiBOdWxsYSBmYWNpbGlzaS4gTnVsbGEgcGVsbGVudGVzcXVlLCBuZXF1ZSBhYyBtYXR0aXMgc29sbGljaXR1ZGluLCBuaXNpIHB1cnVzIG1vbGVzdGllIHR1cnBpcywgYWMgbWF0dGlzIG1hZ25hIGxpZ3VsYSBpbnRlcmR1bSBleC4gQWxpcXVhbSBmcmluZ2lsbGEgZmVybWVudHVtIGVuaW0uIFBlbGxlbnRlc3F1ZSBjb25kaW1lbnR1bSBsZW8gc2l0IGFtZXQgZWdlc3RhcyB1bHRyaWNpZXMuIFZpdmFtdXMgZmFjaWxpc2lzIGxvcmVtIGV1IHF1YW0gY29uZ3VlLCBhYyBjb25ndWUgaXBzdW0gZWxlbWVudHVtLiBWZXN0aWJ1bHVtIGNvbnNlcXVhdCBkdWkgYWMgdG9ydG9yIGJsYW5kaXQgbW9sZXN0aWUuIFByb2luIHRlbXBvciBwb3J0dGl0b3IgZW5pbSBzaXQgYW1ldCB0aW5jaWR1bnQuIER1aXMgY29uZ3VlIG5pc2kgc2VkIG1hc3NhIGZlcm1lbnR1bSBibGFuZGl0LiBOdWxsYSBpbnRlcmR1bSB0b3J0b3IgaWQgYmliZW5kdW0gbGFjaW5pYS4iLCJleHRyYTEiOiJNYWVjZW5hcyBhIHBsYWNlcmF0IGRpYW0uIERvbmVjIHZlbmVuYXRpcyBhdWd1ZSB2b2x1dHBhdCB0dXJwaXMgbWF4aW11cywgbmVjIHZlbmVuYXRpcyBqdXN0byBmZXVnaWF0LiBVdCBjb25ndWUgbWV0dXMgdXQgc29sbGljaXR1ZGluIGhlbmRyZXJpdC4gTmFtIGluIGxlbyBvZGlvLiBDcmFzIGlkIGF1Z3VlIG9yY2kuIFNlZCBpZCBkYXBpYnVzIG51bGxhLCBhIHB1bHZpbmFyIGp1c3RvLiBWZXN0aWJ1bHVtIHVsdHJpY2VzIG51bmMgbm9uIG51bGxhIHJob25jdXMgcmhvbmN1cy4gTW9yYmkgZ3JhdmlkYSBlc3QgcXVpcyBxdWFtIHZlbmVuYXRpcyBhbGlxdWFtLiBGdXNjZSBsYWN1cyBmZWxpcywgZXVpc21vZCBpZCB1bHRyaWNpZXMgdml0YWUsIHNvbGxpY2l0dWRpbiBhdCBzZW0uIE1hZWNlbmFzIGF0IG51bmMgbWFzc2EuIFBlbGxlbnRlc3F1ZSBwdWx2aW5hciBsaWJlcm8gYWMgbWF4aW11cyBzZW1wZXIuIFF1aXNxdWUgaW4gdHVycGlzIHNhcGllbi4gTnVsbGEgbGFjaW5pYSBkdWkgZW5pbSwgdnVscHV0YXRlIG1vbGxpcyBleCB0aW5jaWR1bnQgc2VkLiBNYXVyaXMgcmlzdXMgbWFnbmEsIHZpdmVycmEgZXUgbmlzbCB2ZWwsIGNvbnZhbGxpcyBkaWduaXNzaW0gb3JjaS4gUGVsbGVudGVzcXVlIGZhdWNpYnVzIGVyb3MgcXVhbSwgaW4gYmxhbmRpdCByaXN1cyBlbGVpZmVuZCBuZWMuIiwiZXh0cmEyIjoiRG9uZWMgdml2ZXJyYSBvZGlvIHZlbCBzb2xsaWNpdHVkaW4gc29sbGljaXR1ZGluLiBEb25lYyBmZXJtZW50dW0gcmlzdXMgc2l0IGFtZXQgZXggdGluY2lkdW50LCBzYWdpdHRpcyBwb3N1ZXJlIHZlbGl0IGltcGVyZGlldC4gU2VkIHZlc3RpYnVsdW0gcXVhbSBpbiB2ZWhpY3VsYSBzZW1wZXIuIFByYWVzZW50IGV0IHRlbGx1cyBpZCBtYXVyaXMgZWxlbWVudHVtIHZpdmVycmEuIFBlbGxlbnRlc3F1ZSBxdWFtIGVuaW0sIHVsbGFtY29ycGVyIHV0IG5pc2kgdml0YWUsIGNvbnNlY3RldHVyIGRhcGlidXMgdGVsbHVzLiBOdW5jIGlkIHNvbGxpY2l0dWRpbiBuaXNsLiBGdXNjZSBmYWNpbGlzaXMgZXJvcyBsaWJlcm8sIHZpdGFlIGx1Y3R1cyBzZW0gZnJpbmdpbGxhIHF1aXMuIFNlZCB2YXJpdXMgdGVtcHVzIHR1cnBpcywgc2l0IGFtZXQgYWxpcXVhbSBuaWJoIGFsaXF1ZXQgY29uc2VjdGV0dXIuIERvbmVjIGZhY2lsaXNpcyBtZXR1cyByaXN1cywgbmVjIHBsYWNlcmF0IHRlbGx1cyBsdWN0dXMgYXQuIEN1cmFiaXR1ciBhYyB2ZWxpdCBhIGVuaW0gbHVjdHVzIGZpbmlidXMgYWMgdml0YWUgbGFjdXMuIE5hbSBldWlzbW9kIGR1aSBlZ2V0IHRpbmNpZHVudCBsYW9yZWV0LiBNYWVjZW5hcyBzZW1wZXIgbGVjdHVzIGxvcmVtLCBzaXQgYW1ldCBvcm5hcmUgbWFzc2EgbGFjaW5pYSBpZC4ifQ.r2E3SF9igp6vWAieM0s6lEEI1BDXBm7e6jh8P2iAbrA";

    private void testWorker( ConvertFacade facade ) {
        for ( String original : Arrays.asList( TEXT_SIZE_1, TEXT_SIZE_2, TEXT_SIZE_3, TEXT_SIZE_4, TEXT_SIZE_5 ) ) {
            String data = facade.getUtil().store( original );
            BigDecimal gain = new BigDecimal( 100D-((double)data.length())/((double)original.length())*100D ).setScale( 2, RoundingMode.HALF_EVEN );
            log.info( " original length : {}, store length : {}, gain : {}, Convert FQCN {}, data : {}", original.length(), data.length(), gain, facade.getUtil().getClass().getName(), data );
            String load = facade.getUtil().load( data );
            Assertions.assertEquals( original, load );
        }
    }

    @Test
    void testConvert() {
        ConvertFacade facade = new ConvertFacade();
        // conversion with pass
        log.info( "*** 1) convert : pass through" );
        facade.setUtil( new PassThroughConvertUtil() );
        testWorker( facade );
        // conversion deflate
        log.info( "*** 2) convert : deflate" );
        facade.setUtil( new DeflateUtil() );
        testWorker( facade );
        // convert jwt
        log.info( "*** 3) convert : custom" );
        facade.setUtil( new ConvertJWT() );
        testWorker( facade );
        // convert / deflate jwt
        log.info( "*** 4) convert : composite deflate / custom" );
        facade.setUtil( new DeflateJWT() );
        testWorker( facade );
        // convert / deflate alt
        log.info( "*** 5) convert : composite deflate alt" );
        facade.setUtil( new DeflateGzipUtil() );
        testWorker( facade );
    }

}
